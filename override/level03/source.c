#include <time.h>
#include <stdlib.h>
#include <stdio.h>


void decrypt(int rand) {
	char key[17];
	size_t len;

	key[0] = 'Q';
	key[1] = '}';
	key[2] = '|';
	key[3] = 'u';
	key[4] = '`';
	key[5] = 's';
	key[6] = 'f';
	key[7] = 'g';
	key[8] = '~';
	key[9] = 's';
	key[10] = 'f';
	key[11] = '{';
	key[12] = '}';
	key[13] = '|';
	key[14] = 'a';
	key[15] = '3';
	key[16] = '\0';
	len = strlen(key);
	for (int i = 0; i < len; i++) {
		key[i] ^= rand;
	}
	if (strncmp("Congratulations!", key, sizeof(key)) {
		system("/bin/sh");
	} else {
		puts("Invalid Password");
	}
}

void test(int input, int leetdood) {
	int ccase;

	ccase = leetdood - input;
	/*
		partie reloue en asm ici
		il soustrait les 2 params comme sur la ligne precedente, puis compare avec 15, si c est
		different il va prendre ccase * 4 shl 2
		cf 
		0x08048766 <+31>:	mov    eax,DWORD PTR [ebp-0xc]
		0x08048769 <+34>:	shl    eax,0x2
		0x0804876c <+37>:	add    eax,0x80489f0
		0x08048771 <+42>:	mov    eax,DWORD PTR [eax]
		0x08048773 <+44>:	jmp    eax
		ce ptit coquin va regarder a 0x80489f0 + 4 * input des addresses qui correspondent a mes cas de switch case
		donc si on affiche 0x80489f0 on va display 
		0x80489f4: d ici0x08048775	0x08048785	0x08048795	0x080487a5
		0x8048a04:	0x080487b5	0x080487c5	0x080487d5	0x080487e2
		0x8048a14:	0x080487ef a la 0x0804884a	0x0804884a	0x0804884a
		0x8048a24:	0x0804884a	0x0804884a	0x0804884a	0x080487fc
		0x8048a34:	0x08048809	0x08048816	0x08048823	0x08048830
		0x8048a44:	0x0804883d	0x2a2a2a2a	0x2a2a2a2a	0x2a2a2a2a
		on a la liste de nos calls a decrypt de 1 a 9, puis 6 cas qui redirigent vers rand, puis 
		enfin les adresses des calls de decrypt 10 a 16 - valeurs de input => [ leetdood-15; leetdood-21]
		on a donc bien leetdood - 18 qui nous fait passer dans le cas ou on transformela clef en 
		congratulations et on win

	*/
	switch (ccase) {
		default:
			ccase = rand();
			decrypt(ccase); // wtf are the params from ghidra, idk yet
			break;
		case 1:
			decrypt(ccase);
			break;
		case 2:
			decrypt(ccase);
			break;
		case 3:
			decrypt(ccase);
			break;
		case 4:
			decrypt(ccase);
			break;
		case 5:
			decrypt(ccase);
			break;
		case 6:
			decrypt(ccase);
			break;
		case 7:
			decrypt(ccase);
			break;
		case 8:
			decrypt(ccase);
			break;
		case 9:
			decrypt(ccase);
			break;
		case 16:
			decrypt(ccase);
			break;
		case 17:
			decrypt(ccase);
			break;
		case 18://pass
			decrypt(ccase);
			break;
		case 19:
			decrypt(ccase);
			break;
		case 20:
			decrypt(ccase);
			break;
		case 21:
			decrypt(ccase);
			break;
	}


}

int main(int argc, char *argv[])
{
	time_t seed;
	int input;

	seed = time(NULL);
	srand(seed);
	puts("***********************************");
	puts("*		level03		**");
	puts("***********************************");
	printf("Password:");
	scanf("%d", &input); // back here test dif	ferebnt input possibilities, m+108
	test(input, 0x1337d00d);
	return 0;
}
