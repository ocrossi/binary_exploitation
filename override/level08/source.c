#include <string.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>


void log_wrapper(FILE *file, char *msg, char *src_filename) {
	char buff[264];
	int len_p1;
	int len_p2;
	size_t ret;


	strcpy(buff, msg);
	len_p1 = strlen(buff);
	len_p2 = strlen(buff+len_p1);
	snprintf(buff+len_p1, 0xfe, "%s\n", src_filename);
	ret = strcspn(buff, "\n");
	buff[ret] = '\0';
	fprintf(file, "LOG: %s\n", buff);
	/* canary */
	return;
}

int main(int argc, char *argv[])
{
	FILE *inputFile;
	FILE *backupFile;


	if (argc != 2) {
		printf("Usage: %s filename\n", argv[0]);
	}
	backupFile = fopen("./backups/.log" ,"w");
	if (backupFile == 0) {
		printf("ERROR: Failed to open %s\n", "./backups/.log");
		exit(1);
	}
	log_wrapper(backupFile, "Starting back up: ", argv[1]);
	inputFile = fopen(argv[1],"r");
	if (inputFile == (FILE *)0x0) {
		printf("ERROR: Failed to open %s\n",argv[1]);
			    /* WARNING: Subroutine does not return */
		exit(1);
	}
	char *backupDir = "./backups/";
	int len_back = strlen(backupDir);
	strncat(backupDir, argv[1], 99 - len_back);
	int fd = open(backupDir,193,432);
	if (fd < 0) {
		printf("ERROR: Failed to open %s%s\n","./backups/",argv[1]);
		    /* WARNING: Subroutine does not return */
		exit(1);
	}
	while(1) {
		int c = fgetc(inputFile);
		    /* read file content and writes it to ./backups/<filename> */
		if (c == -1)
			break;
		write(fd,&c,1);
	}
	log_wrapper(backupFile,"Finished back up ", argv[1]);
	fclose(inputFile);
	close(fd);
	/* CANARY */

	return EXIT_SUCCESS;
}
