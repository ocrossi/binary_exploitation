#define _GNU_SOURCE

#include <sys/ptrace.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

int auth(char *username, unsigned serial)
{
	size_t ret;
	int auth_error;
	long trace_error;
	int i;
	unsigned acc;

	ret = strcspn(username, "\n");
	username[ret] = '\0';
	ret = strnlen(username, 32);
	if ((int)ret < 6) {
		auth_error = 1;
	}
	else {
		trace_error = ptrace(PTRACE_TRACEME);
		if (trace_error == -1) {
			puts("\x1b[32m.---------------------------.");
			puts("\x1b[31m| !! TAMPERING DETECTED !!	|");
			puts("\x1b[32m\'---------------------------\'");
			auth_error = 1;
		}
		else {
			acc = ((int)username[3] ^ 0x1337U) + 0x5eeded;
			for (i = 0; i < (int)ret; i += 1) {
				if (username[i] < ' ') {
					return 1;
				}
				acc += ((int)username[i] ^ acc) % 0x539;
			}
			if (serial == acc) {
				auth_error = 0;
			}
			else {
				auth_error = 1;
			}
		}
	}
	return auth_error;
}

int main(void)
{
	int auth_error;
	unsigned serial;
	char username [32];

	puts("***********************************");
	puts("*\t\tlevel06\t\t	*");
	puts("***********************************");
	printf("-> Enter Login: ");
	fgets(username, 32, stdin);
	puts("***********************************");
	puts("***** NEW ACCOUNT DETECTED ********");
	puts("***********************************");
	printf("-> Enter Serial: ");
	scanf("%u", &serial);
	auth_error = auth(username, serial);
	if (auth_error == 0) {
		puts("Authenticated!");
		system("/bin/sh");
	}

	return auth_error != 0;
}
